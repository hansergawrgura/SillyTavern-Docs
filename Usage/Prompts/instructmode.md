---
order: prompts-30
route: /usage/core-concepts/instructmode/
---

# 🧠 指令模式

指令模式允许您调整针对各种提示格式（如 Alpaca、ChatML、Llama2 等）训练的指令遵循模型的提示方式。

!!! 适用范围：文本补全 API
聊天补全 API 的等效设置，请使用 [提示词管理器](prompt-manager.md)。
!!!

## API 支持

### 文本补全 API

完全支持。这包括：

*   文本补全下的所有来源
*   KoboldAI Classic
*   AI Horde

#### 选择格式化方式

所选的指令模板必须与后端运行的实际模型的期望相匹配。

这通常在 HuggingFace 的模型卡中有所反映，有些甚至提供与 SillyTavern 兼容的 JSON 文件。

示例：[NeverSleep/Noromaid-13b-v0.1.1](https://huggingface.co/NeverSleep/Noromaid-13b-v0.1.1#prompt-template-custom-format-or-alpaca)

### 聊天补全 API (OpenAI, Claude 等)

聊天补全 API **不支持（也不需要）** 此功能。它们使用完全不同的提示词构建器。

### NovelAI

虽然 NovelAI *技术上* 支持，但其模型均未经过训练以理解指令格式。NovelAI 模型可以使用一个特殊的指令模块，当在聊天消息中遇到用花括号包裹的指令时会*自动*激活，因此对整个提示词使用指令模式将导致输出质量**下降**。

以下是一个为 NovelAI 自动激活指令模块的示例：

```txt
用户：{ 写一首关于 Nintendo Switch 的快乐歌曲。 }
```

## ⚙️ 指令模式设置

### 系统提示词

!!!warning 近期变更
系统提示词现在是一个独立的实体。详情请参阅 [高级格式化](advancedformatting.md#-系统提示词) 页面。
!!!

### 模板

提供一些知名指令模型的、带有序列的现成模板。

*更改模板会将未保存的设置重置为上次保存的状态！如果您进行了任何不想丢失的更改，请不要忘记保存您的模板。*

### 激活正则表达式

如果定义为有效的正则表达式，当连接到模型且其名称匹配此正则表达式时，将自动选择此模板。

需要预先启用指令模式。只有按字母顺序评估的第一个匹配的模板会被选中。

### 使用换行符包裹序列

每个序列文本在插入提示词时将被换行符包裹。Alpaca 及其衍生格式需要此选项。

如果您想完全控制行终止符，请禁用此选项。

### 替换序列中的宏

如果启用，已知的 \{\{宏\}\} 替换将在消息包装序列中被替换（如果已定义）。

此外，可以在消息前缀中使用特殊的 \{\{name\}\} 宏来引用附加到消息的实际名称（而不是当前活动的 \{\{char\}\} 或 \{\{user\}\}}），这在群聊或 /sendas 命令时很有帮助。如果无法确定名称，则使用“System”作为后备占位符。

### 包含名称

如果启用，将在聊天历史记录日志的前缀序列之后附加角色和用户名称。

可用选项如下：

*   **从不**：不在消息内容前添加名称前缀。
*   **群组和过往人格**：仅对来自群组角色和过往人格的消息添加名称前缀。
*   **总是**：总是在消息内容前添加名称前缀。

### 🔄 序列：故事字符串包装

!!!warning 近期变更
系统提示词包装已被移除，并替换为故事字符串包装。
!!!

定义当位置设置为“默认（上下文顶部）”时，故事字符串将如何被包装。

#### 故事字符串前缀

插入到故事字符串之前。

#### 故事字符串后缀

插入到故事字符串之后。

### 🔄 序列：聊天消息包装

这些设置定义了在构建提示词时，属于不同角色的消息将如何被包装。

所有前缀序列也会自动用作停止字符串。

#### 用户消息前缀

插入到用户消息之前，以及在模拟（impersonating）时作为最后的提示词行。

#### 用户消息后缀

插入到用户消息之后。

#### 助手消息前缀

插入到助手消息之前，以及在生成 AI 回复时作为最后的提示词行。

#### 助手消息后缀

插入到助手消息之后。

#### 系统消息前缀

插入到系统消息（由斜杠命令或扩展添加）之前。

#### 系统消息后缀

插入到系统消息之后。

#### 系统同用户

如果勾选为真，系统消息将使用用户角色消息序列。

否则，系统消息将使用其自己的序列（如果不为空）或根本不做任何包装（如果为空）。

### 🔧 其他序列

用于微调提示词构建的各种高级配置。

#### 首个助手前缀

插入到第一个助手消息之前。

!!!info
仅计算**聊天历史**中的第一条消息，而不是实际首先进入提示词的消息！
!!!

#### 最后助手前缀

插入到最后一条助手消息之前，或在生成 AI 回复时作为最后的提示词行。

!!!info
在后台生成文本时（例如，Stable Diffusion 提示词或摘要）不使用。将改用系统指令前缀或常规助手前缀。
!!!

#### 系统指令前缀

在后台生成中性/系统文本时（例如，Stable Diffusion 提示词或摘要），作为最后的提示词行插入。

#### 用户填充消息

如果聊天历史不是以用户消息开头，则将在其开头插入此消息。

**用例：** 当指令格式*严格要求*提示词必须以用户消息开头并且消息角色必须严格交替时，例如：Llama 2 Chat, Mistral Instruct。

#### ⏹️ 停止序列

表示回复结束的文本。也会作为停止字符串发送到后端 API。

如果生成了停止序列，则其后的所有内容（包括序列本身）将从输出中删除。