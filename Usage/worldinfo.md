---
order: 130
icon: globe
route: /usage/core-concepts/worldinfo/
templating: false
---

# 🌍 世界信息

**世界信息（也称为传说书或记忆书）是 ST 中一个强大的工具，可动态将提示词插入您的聊天中，以帮助引导 AI 回复。**

通常，世界信息（简称 WI）用于增强 AI 对您虚构世界中细节的理解，但您也可以使用世界信息条目插入您希望插入提示词中的**任何内容**。

它就像一个动态词典，只有当与条目关联的关键词出现在消息文本中时，才会插入世界信息条目中的相关信息。

SillyTavern 引擎会激活并无缝地将相应的背景知识集成到提示词中，为 AI 提供背景信息。

*需要注意的是，虽然世界信息有助于引导 AI 生成期望的内容，但它并不保证其一定会出现在生成的输出消息中。这取决于您的模型利用附加信息的能力！*

## 💡 专业提示

*   世界信息引擎是一个非常强大的提示词管理工具。不要只局限于添加角色背景知识，请随意尝试。
*   激活关键词、标题以及**内容**字段以外的其他信息不会被插入上下文中，因此每个世界信息条目都应包含一个全面的、独立的描述。
*   要创建丰富详细的世界背景知识，条目可以通过递归激活相互链接和引用。详见下文关于[递归扫描](#递归扫描-recursive-scanning)的内容。
*   SillyTavern 为插入的背景信息提供了灵活的上下文预算。为节省提示词词元，建议保持条目内容简洁。

## 📚 延伸阅读

*   [世界信息百科全书](https://rentry.co/world-info-encyclopedia): 关于世界信息和传说书的详尽深入指南。作者：kingbri, Alicat, Trappu。

## 👤 角色背景知识

可以选择将一个世界信息文件分配给一个角色，作为与该角色所有聊天（包括群组）的专用背景知识来源。

操作方法：导航到角色管理面板，点击地球仪按钮，然后从下拉列表中选择世界信息，点击“确定”。

要解除绑定或更改角色背景知识，请按住 Shift 键点击地球仪按钮。如果在移动设备上，请点击“更多...”，然后点击“链接世界信息”。

### 角色背景知识插入策略

生成 AI 回复时，角色世界信息中的条目将与全局世界信息选择器中的条目使用以下策略之一组合：

#### 均匀排序（默认）

所有条目将根据其插入顺序进行排序，就好像它们是一个大文件的一部分，忽略来源。

#### 角色背景知识优先

首先按插入顺序包含角色世界信息中的条目，然后是全局世界信息中的条目。

#### 全局背景知识优先

首先按插入顺序包含全局世界信息中的条目，然后是角色世界信息中的条目。

## 📝 世界信息条目

#### 关键词 (Key)

触发世界信息条目激活的关键词列表。默认情况下关键词不区分大小写（此功能[可配置](#区分大小写的关键词-case-sensitive-keys)）。

##### 将正则表达式 (Regex) 用作关键词

关键词支持通过正则表达式进行更灵活的匹配。这使得可以匹配更具动态性的内容，包括可选单词或字符、空格以及正则表达式提供的所有其他功能。
如果定义的关键词是有效的正则表达式（JavaScript 正则表达式风格，以 `/` 作为分隔符。允许所有标志），则在检查是否应触发条目时将其视为正则表达式。多个正则表达式可以作为单独的关键词输入，并且可以协同工作。在正则表达式内部，可以使用逗号。纯文本关键词不支持逗号，因为它们被视为关键词分隔符。

高级正则表达式匹配的使用示例：
一个应在角色执行与天气相关的动作时插入的条目/指令

```js
/(?:{{char}}|he|she) (?:is talking about|is noticing|is checking whether|observes) (?:the )?(rainy weather|heavy wind|it is going to rain|cloudy sky)/i
```

有关正则表达式语法和可能性的更多信息：[正则表达式 - JavaScript | MDN](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Guide/Regular_expressions)

###### 高级正则表达式逐消息匹配

ST 在世界信息扫描缓冲区中的每条聊天消息前添加 `角色名称:`，并在 v1.12.6 之后使用字符值 1 (`\x01`) 连接它们。
这意味着您可以使用绑定到该分隔字符的正则表达式来匹配特定角色的特定输入或输出。

例如，要仅匹配用户说“hello”，您可以使用以下正则表达式：

```js
/\x01{{user}}:[^\x01]*?hello/
```

##### 关键词输入

有两种输入关键词的模式，每种模式的用户界面略有不同。在 ⌨️ *纯文本模式*（默认）下，关键词可以在单个文本字段中以逗号分隔列表的形式输入。也可以包含正则表达式，但它们没有任何特殊高亮显示。在 ✨ *高级模式*下，关键词显示为单独的元素，正则表达式将如此高亮显示。该控件支持编辑和删除关键词。可以通过输入控件内的行内按钮切换模式。

#### 可选过滤器 (Optional Filter)

与主关键词结合使用的附加关键词的逗号分隔列表。
如果未提供参数，则忽略此标志。
支持 AND ANY、NOT ANY 或 NOT ALL 逻辑

1.  AND ANY = 仅当主关键词**和**可选过滤器关键词中的**任何一个**存在于扫描的上下文中时才激活条目。
2.  AND ALL = 仅当主关键词**和**所有可选过滤器关键词都存在时才激活条目。
3.  NOT ANY = 仅当主关键词存在**且**可选过滤器关键词中的**任何一个都未**出现在扫描的上下文中时才激活条目。
4.  NOT ALL = 如果所有可选过滤器都出现在扫描的上下文中，则**阻止**条目激活，尽管主关键词已触发。

这些关键词也支持[正则表达式](#将正则表达式-regex-用作关键词)。

#### 条目内容 (Entry Content)

条目激活时插入到提示词中的文本。

#### 插入顺序 (Insertion Order)

数字值。定义多个条目同时激活时的优先级。插入顺序值较高的条目将插入到上下文的更靠近末尾的位置，因为它们对输出的影响更大。

#### 插入位置 (Insertion Position)

*   **角色定义前 (Before Char Defs):** 世界信息条目插入在角色描述和场景之前。对对话有中等影响。
*   **角色定义后 (After Char Defs):** 世界信息条目插入在角色描述和场景之后。对对话有较大影响。
*   **示例消息前 (Before Example Messages):** 世界信息条目被解析为示例对话块，并插入在角色卡提供的示例之前。
*   **示例消息后 (After Example Messages):** 世界信息条目被解析为示例对话块，并插入在角色卡提供的示例之后。
*   **作者注记顶部 (Top of AN):** 世界信息条目插入在作者注记内容的顶部。影响程度取决于作者注记的位置。
*   **作者注记底部 (Bottom of AN):** 世界信息条目插入在作者注记内容的底部。影响程度取决于作者注记的位置。
*   **@ 深度 (@ D):** 世界信息条目插入到聊天中的特定深度（深度 0 为提示词的底部）。
    *   ⚙️ - 作为系统角色消息
    *   👤 - 作为用户角色消息
    *   🤖 - 作为助手角色消息

示例消息条目将根据提示词构建设置进行格式化：指令模式或聊天补全提示词管理器。它们也遵循示例消息行为规则：在上下文满时逐渐被推出、始终保留或完全禁用。

如果您的作者注记被禁用（插入频率 = 0），则位于作者注记位置的世界信息条目将被忽略！

#### 条目标题 / 备忘录 (Entry Title / Memo)

一个方便的文本字段，用于标记您的条目，AI 或任何触发逻辑都不会使用它。

如果为空，可以通过点击“填充空备忘录”按钮使用条目的第一个关键词来回填。

#### 策略 (Strategy)

1.  🔵 (蓝色圆圈) = 该条目将始终存在于提示词中。
2.  🟢 (绿色圆圈) = 该条目仅在存在关键词时触发。
3.  🔗 (链条链接) = 允许通过嵌入相似性插入该条目。

每个条目还有一个切换开关，允许您启用或禁用该条目。

#### 概率 (触发%) (Probability (Trigger %))

此值就像一个附加过滤器，当条目通过任何方式（常量、主关键词、递归）激活时，增加一个不插入该条目的机会。

1.  概率 = 100 意味着该条目将在每次激活时插入。
2.  概率 = 50 意味着该条目有 1:1 的机会被插入。
3.  概率 = 0 意味着该条目将**不**被插入（实质上禁用它）。

使用此功能在聊天中创建随机事件。例如，每条消息都有 1% 的几率在消息中提到其名字时唤醒一个上古之神。

#### 包含组 (Inclusion Group)

包含组控制当多个具有相同组标签的条目同时被触发时如何选择条目。如果多个具有相同组标签的条目被激活，则只有一个会插入到提示词中。

默认情况下，根据它们的组权重（默认是 100 点）随机选择条目——数字越高，被选中的概率越高。这允许在触发的条目中进行随机选择，为交互增加惊喜和多样性。

如果一个条目被定义为逗号分隔的列表，则它可以属于多个包含组。将应用上述相同的逻辑。如果该条目被触发，它将*禁用*属于其任何组的所有其他条目。因此，如果任何组被激活，此条目将不会被激活。

#### 优先包含 (Prioritize Inclusion)

为了提供对通过[包含组](/Usage/worldinfo.md#包含组-inclusion-group)激活哪些条目的更多控制，您可以使用“优先包含”设置。此选项允许您确定性地选择要选择的条目，而不是随机滚动组权重机会。

如果多个具有相同组标签且启用此设置的条目被激活，则将选择具有最高“顺序”值的条目。这对于通过包含组创建后备序列很有用。例如，优先处理深度较低、更强调的条目，或者在两者都有效时选择特定的场景设置指令。

#### 使用组评分 (Use Group Scoring)

当全局或每个条目启用此设置时，激活的条目关键词数量决定组获胜者的选择。只有具有最多关键词匹配的组子集才会留待通过组权重或包含优先级激活 - 其余的将被停用并从组中移除。

使用此功能为大型组中的单个条目提供更多特异性。例如，它们可以有一个通用关键词和一个特定关键词。当未提供特定关键词时，将插入随机条目，反之亦然。

主关键词的分数计算逻辑是：1 次匹配 = 1 分。

对于辅助关键词，交互取决于所选的筛选逻辑：

1.  AND ANY: 1 次辅助匹配 = 1 分。
2.  AND ALL: 如果所有辅助关键词都匹配，则每个辅助关键词得 1 分。
3.  NOT ANY 和 NOT ALL: 无变化。

示例：

*   条目 1. 关键词: song, sing, Black Cat. 组: songs
*   条目 2. 关键词: song, sing, Ghosts. 组: songs

输入 `sing me a song` 可以激活任一条目（两者都激活了 2 个关键词），但 `sing me a song about Ghosts` 将仅激活条目 2（激活了 3 个关键词）。

#### 自动化 ID (Automation ID)

允许将世界信息条目与快速回复扩展中的 [STscripts](/For_Contributors/st-script.md) 集成。如果快速回复命令和 WI 条目具有相同的自动化 ID，则在激活具有匹配 ID 的条目时将自动执行该命令。

自动化按照它们被触发的顺序执行，遵循您指定的排序策略，结合[角色背景知识插入策略](#角色背景知识插入策略)和“优先级”排序。这导致[蓝色圆圈](#策略-strategy)条目首先被处理，然后是其他条目按其指定的“顺序”处理。递归触发的条目将在之后以相同的顺序处理。

如果多个具有相同自动化 ID 的条目被激活，脚本命令将仅运行一次。

#### 角色过滤器 (Character Filter)

此条目可以为其激活的角色名称列表。如果此列表不为空，则该条目仅对名称在列表中的角色激活。当选择一个标签时，该条目将仅对具有该特定标签的角色激活。

“排除”模式会反转过滤器，意味着该条目将对所有角色激活，除了添加到列表中的角色或具有所选标签的角色。

#### 触发器 (Triggers)

可以激活此世界信息条目的生成类型。如果未选择任何内容，则该条目可以针对所有生成类型激活。如果选择了一个或多个，则该条目将仅针对那些特定的生成类型激活：

*   **普通 (Normal):** 常规消息生成请求。
*   **继续 (Continue):** 当按下继续按钮时。
*   **模拟 (Impersonate):** 当按下模拟按钮时。
*   **滑动 (Swipe):** 当通过滑动触发生成时。
*   **重新生成 (Regenerate):** 在单人聊天中按下重新生成按钮时。
*   **静默 (Quiet):** 后台生成请求，通常由[扩展](/extensions/index.md)或[STscript](/For_Contributors/st-script.md)命令触发。

!!!
“重新生成”触发器在群聊中不可用，因为它使用不同的重新生成逻辑：删除最后一条回复的所有消息，并根据所选的[群聊回复策略](/Usage/Characters/groupchats.md#-回复顺序策略)使用“普通”生成类型对消息进行排队。
!!!

#### 附加匹配源 (Additional matching sources)

默认情况下，世界信息条目仅针对当前对话的内容进行匹配。这些选项允许您针对不显示在聊天中的不同角色信息，甚至人格信息进行匹配。当您希望拥有范围广泛的条目用于多个角色之间，但又不想管理庞大的标签列表，或者不想在每次创建新角色时更新角色过滤器列表时，这非常有用。这也允许您根据当前活动的人格进行匹配。

*   **角色描述 (Character Description)**: 针对角色描述进行匹配。
*   **角色性格 (Character Personality)**: 针对角色性格摘要进行匹配，可在高级定义下找到。
*   **场景 (Scenario)**: 针对角色指定的场景进行匹配，可在高级定义下找到。
*   **人格描述 (Persona Description)**: 针对当前所选人格的描述进行匹配。
*   **角色的注释 (Character's Note)**: 针对角色的注释进行匹配，可在高级定义下找到。
*   **创作者注释 (Creator's Notes)**: 针对角色创作者的注释进行匹配，可在高级定义下找到。创作者的注释通常不包含在提示词中。

## 🔢 向量存储匹配 (Vector Storage Matching)

向量存储扩展提供了一种替代关键词匹配的方法，它使用最近聊天消息与世界信息条目内容之间的相似性。

要启用和使用此功能，需要满足以下先决条件：

1.  向量存储扩展已启用，并配置为使用可用的嵌入源之一。
2.  向量存储扩展设置中勾选了“为世界信息启用”复选框。
3.  要么允许进行无关键词匹配的世界信息条目具有“向量化”(🔗) 状态，要么在向量存储设置中勾选“为所有条目启用”选项。

扩展中选择的向量化模型以及术语“嵌入”背后的理论含义在此不做介绍。如果您需要有关此主题的更多信息，请查看[数据库](/Usage/Characters/data-bank.md#-向量存储)指南。

向量存储匹配遵循以下规则集：

*   允许与向量存储匹配的最大条目数可以通过“最大条目数”设置进行调整。此数字仅设置限制，不影响为世界信息激活设置中设置的词元预算。所有预算规则仍然适用。
*   此功能仅替代对关键词的检查。条目要插入，必须满足所有附加检查：触发%、角色过滤器、包含组等。
*   不使用来自激活设置或条目覆盖的“扫描深度”设置。而是使用向量存储的“查询消息”值来获取要匹配的文本。这允许进行诸如将“扫描深度”设置为 0 的配置，这样就不会进行常规的关键词匹配，但条目仍然可以被向量激活。
*   “向量化”状态只是一个附加标记。该条目仍然表现得像一个正常的、已启用的、非常量记录，如果设置了关键词，它将被关键词激活。如果您希望它们仅由向量激活，请移除关键词。

!!!info 注意
由于检索质量完全取决于嵌入模型的输出，因此无法准确预测将插入哪些条目。如果您需要确定性和可预测的结果，请坚持使用关键词匹配。
!!!

## ⏱️ 定时效果 (Timed Effects)

通常，世界信息评估是无状态的，这意味着评估结果相同，仅取决于当前的聊天上下文。但是，随着定时效果的引入，您可以创建具有激活延迟、触发后保持活动状态或在激活后无法触发的条目。

### 定时效果规则

1.  效果的时间范围以消息数（不是消息对/交换）衡量，0 表示没有效果。
2.  效果仅适用于条目被激活的聊天。分支继承父聊天的状态。
3.  如果聊天没有进展，例如最后一条消息被滑动或删除，则活动的定时效果将被移除。
4.  对当前具有定时效果的条目进行任何更改将导致效果被强制移除。
5.  关键词的后续触发不会刷新效果持续时间（如果它已经处于活动状态）。

### 定时效果类型

1.  粘性 (Sticky) - 条目在激活后保持活动状态 N 条消息。粘性条目在后续扫描中忽略概率检查，直到它们过期。
2.  冷却 (Cooldown) - 条目在激活后的 N 条消息内无法被激活。可以与粘性一起使用：条目在粘性持续时间结束后进入冷却。
3.  延迟 (Delay) - 除非在评估时聊天中至少有 N 条消息，否则无法激活条目。
    *   延迟 = 0 -> 条目可以随时激活。
    *   延迟 = 1 -> 如果聊天为空（没有问候语），则无法激活条目。
    *   延迟 = 2 -> 如果聊天中有零条或仅一条消息，则无法激活条目，依此类推。

### 定时效果示例

条目配置：粘性 = 3，冷却 = 2，延迟 = 2。

```txt
消息 0: 延迟
消息 1: 条目激活
消息 2: 粘性
消息 3: 粘性
消息 4: 粘性
消息 5: 冷却
消息 6: 冷却
消息 7: 条目可以再次激活
```

## ⚙️ 激活设置 (Activation Settings)

世界信息屏幕顶部的可折叠菜单。

### 扫描深度 (Scan Depth)

> 可在条目级别覆盖。

定义应扫描聊天历史中的多少条消息以查找世界信息关键词。

*   如果设置为 0，则仅评估递归条目和作者注记。
*   如果设置为 1，则 SillyTavern 仅扫描最后一条消息。
*   2 = 最后两条消息，依此类推。

### 包含名称 (Include Names)

定义是否应将聊天参与者的名称作为消息前缀包含在扫描的文本缓冲区中。这允许激活使用名称作为关键词的条目，而无需直接在消息中提及名称。

参见下面要扫描的文本示例，假设聊天参与者名为 Alice 和 Bob。

启用（默认）：

```txt
Alice: Hello! Good to see you.
Bob: How is the weather today?
```

禁用：

```txt
Hello! Good to see you.
How is the weather today?
```

### 上下文 % / 预算 (Context % / Budget)

**定义世界信息条目一次可以使用的词元数量。**
您可以定义相对于 API 最大上下文设置（上下文%）的阈值或客观的词元阈值（预算）

如果预算耗尽，那么即使提示词中存在关键词，也不会激活更多条目。

常量条目将首先插入。然后是插入顺序值较高的条目。

通过直接提及其关键词插入的条目比那些在其他条目内容中提到的条目具有更高的优先级。

### 最小激活数 (Min Activations)

**此设置与最大递归步骤互斥。**

最小激活数：如果设置为非零值，这将忽略“扫描深度”的限制，从最新消息向后搜索所有聊天记录以查找关键词，直到触发指定数量的条目。这仍将受到最大深度设置或您的总体预算上限的限制。

*由最小激活数触发的额外扫描不会检查在前几步通过递归添加的条目。只有聊天消息和扩展提示词可以触发这些额外的激活。但是，由最小激活数激活的条目可以像往常一样触发其他条目。*

### 最大深度 (Max Depth)

使用最小激活数设置时扫描的最大深度。

### 递归扫描 (Recursive scanning)

递归扫描允许条目激活其他条目或被其他条目激活，从而实现不同世界信息条目之间的复杂交互和依赖关系。此功能可以显著增强创意场景的动态性。
是否启用递归扫描可以通过全局设置**递归扫描 (Recursive Scan)** 来控制。
每个条目有三个选项可用于控制递归：

1.  **不可递归 (Non-recursable)**: 选中此复选框后，该条目不会被其他条目激活。这对于不应更改或受其他世界信息条目影响的静态信息很有用。
2.  **阻止进一步递归 (Prevent further recursion)**: 选择此选项可确保一旦此条目被激活，它将不会触发任何其他条目。这有助于避免意外的激活链。
3.  **延迟至递归 (Delay until recursion)**: 此条目仅在递归检查期间激活，这意味着它不会在初始过程中触发，但可以被启用了递归的其他条目激活。现在，为这些延迟添加了**递归级别**，条目按级别分组。最初，只有第一级（最小数字）会匹配。一旦找不到匹配项，下一级就有资格进行匹配，重复此过程直到检查完所有级别。这允许更好地控制如何在递归期间揭示更深层次的信息，特别是与 NOT ANY 或 NOT ALL 关键词匹配组合等条件结合使用时。

**条目可以通过在其内容文本中提及其他条目的关键词来激活它们。**

例如，如果您的世界信息包含两个条目：

```txt
条目 #1
关键词: Bessie
内容: Bessie 是一头牛，是 Rufus 的朋友。
```

```txt
条目 #2
关键词: Rufus
内容: Rufus 是一条狗。
```

如果消息文本**仅提及 Bessie**，则**两者**都将被拉入上下文。

### 最大递归步骤 (Max Recursion Steps)

**此设置与最小激活数互斥。**

当设置为零时，递归嵌套仅受您的提示词预算限制。当设置为非零值时，将总扫描次数限制为所需的最大“嵌套级别”。

示例值：

*   1 有效地禁用递归，因为检查在第一步后停止。
*   2 只能激活递归条目一次。
*   3 可以触发递归两次...

### 区分大小写的关键词 (Case-sensitive keys)

> 可在条目级别覆盖。

**要拉入上下文，条目关键词需要与世界信息条目中定义的大小写匹配。**

当您的关键词是常见单词或常见单词的一部分时，这很有用。

例如，当此设置处于活动状态时，关键词 'rose' 和 'Rose' 将根据输入进行不同的处理。

### 匹配完整单词 (Match whole words)

> 可在条目级别覆盖。

仅包含一个单词的关键词的条目仅当整个单词出现在搜索文本中时才会匹配。默认启用。

例如，如果启用此设置且条目关键词是 "king"，那么像 "long live the king" 这样的文本将被匹配，但 "it's not to my liking" 则不会。

**重要提示：** 此设置可能对不使用空格分隔单词的语言（例如日语或中文）产生不利影响。如果您使用这些语言编写条目，建议保持关闭。

### 溢出警报 (Alert on overflow)

如果激活的世界信息超过分配的词元预算，则显示警报。